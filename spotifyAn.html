<!DOCTYPE html>
<html>
<head>
	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-114382787-2"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());
	  gtag('config', 'UA-114382787-2');
	</script>
	
    <script type="text/javascript" src = "js/darkMode.js"></script>

	<link rel="apple-touch-icon" sizes="180x180" href="resources/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="resources/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="resources/favicon-16x16.png">
	<link rel="manifest" href="resources/site.webmanifest">
	<link rel="mask-icon" href="resources/safari-pinned-tab.svg" color="#5bbad5">
	<meta name="msapplication-TileColor" content="#da532c">
	<meta name="theme-color" content="#ffffff">
	<meta charset="utf-8">
	<meta content="width=device-width, initial-scale=1" name="viewport">
	<title>Joe Pitts</title>
	<link rel="stylesheet" type="text/css" href="style.css">
	<script type="text/javascript" src="js/vis.min.js"></script>
	<script type="text/javascript" src="js/spotify-web-api.js"></script>
	<link href="vis.min.css" rel="stylesheet" type="text/css" />

	<meta name = "description" content = "The personal website for Joe Pitts, Programmer, Photographer, England, UK, Coding!">
</head>
<body link = "black">
	<div id = "content" class="content">
		<header>
			<div id="containter">

					<div>
							<img id = "logo" src="resources/logo.jpg" ,="" height:10%,="" width="10%,">
							<a id = "title" href="index.html">
									<h1>&nbsp;Joe Pitts</h1>
							</a>
							<div class="burger" onclick="document.getElementById('drop').click();">
									<div></div>
									<div></div>
									<div></div>
							</div>
					</div>

			</div>
			<aside>
					<nav>
							<label class="toggle" for="drop" style="pointer-events: none;"></label>
							<input id="drop" type="checkbox">
							<ul class="menu">
								<li>
										<a href="index.html">Home</a>
								</li>
								<li>
										<a href="demos.html">Demos</a>
								</li>
								<li>
										<a href="work.html">My Work</a>
								</li>
								<li>
										<a href="https://www.linkedin.com/in/joepittsy/">Linkedin</a>
								</li>
								<li>
										<a href="instagram.html">Photography</a>
								</li>
								<li>
										<a href="#" onclick="toggleNightMode(); ">Dark Mode</a>
								</li>
						</ul>
					</nav>
					<!-- <form style="display: inline;" action="index.html"> <button>| Home |</button></form>
							<form style="display: inline;" action="demos.html"> <button> Demos |</button></form>
							<form style="display: inline;" action="instagram.html"> <button>Photography |</button></form>
							<form style="display: inline;" onsubmit="toggleNightMode(); return false;" return false"> <button>
											Toggle Dark Mode|</button></form> -->
			</aside>
	</header>
		<hr>
		<div id="login" style="">
			<form class="form-container" >
			<div class="form-title"><h2>Spotify Visualizer</h2></div>
			<div class="form-title">Time-Frame</div>
		 	<select id="time" style="width: 100%">
			  <option value="short_term">Short-Term</option>
			  <option value="medium_term">Medium-Term</option>
			  <option value="long_term">Long-Term</option>
			</select> <br />
			
			<div class="submit-container">
				<button type = button id="login-button" class="btn">Log in with Spotify</button>				
			</div>
			</form>

		</div>
	</div>
	<style>
		#mynetwork {
			width: 100%;
			height: 100%;
		}
		#wrapper {
			height:100%;
			width:100%;
			background-color:#9ACD32;
		}
	</style>
<!--	  <div class="container">
	  <div id="login">
		<button id="login-button" class="btn btn-primary">Log in with Spotify</button>
	  </div>
	</div>
 -->


	<script id="oauth-template" type="text/x-handlebars-template">
	  <h2>oAuth info</h2>
	  <dl class="dl-horizontal">
		<dt>Access token</dt><dd class="text-overflow">{{access_token}}</dd>
	  </dl>
	</script>

	<script src="js/handlebars.min.js"></script>
	<script src="js/jquery-1.10.1.min.js"></script>
	<script>
	function formatParams( params ){
	  return "?" + Object
			.keys(params)
			.map(function(key){
			  return key+"="+encodeURIComponent(params[key])
			})
			.join("&")
	}
	function getJSONP(url, success) {
		var ud = '_' + +new Date,
			script = document.createElement('script'),
			head = document.getElementsByTagName('head')[0] 
				   || document.documentElement;
		window[ud] = function(data) {
			head.removeChild(script);
			success && success(data);
		};
		script.src = url.replace('callback=?', 'callback=' + ud);
		head.appendChild(script);
	}
	  (function() {
		var stateKey = 'spotify_auth_state';
		/**
		 * Obtains parameters from the hash of the URL
		 * @return Object
		 */
		function getHashParams() {
		  var hashParams = {};
		  var e, r = /([^&;=]+)=?([^&;]*)/g,
			  q = window.location.hash.substring(1);
		  while ( e = r.exec(q)) {
			 hashParams[e[1]] = decodeURIComponent(e[2]);
		  }
		  return hashParams;
		}
		/**
		 * Generates a random string containing numbers and letters
		 * @param  {number} length The length of the string
		 * @return {string} The generated string
		 */
		function generateRandomString(length) {
		  var text = '';
		  var possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
		  for (var i = 0; i < length; i++) {
			text += possible.charAt(Math.floor(Math.random() * possible.length));
		  }
		  return text;
		};
		var params = getHashParams();
		access_token = params.access_token,
			state = params.state,
			storedState = localStorage.getItem(stateKey);
		if (access_token && (state == null || state !== storedState)) {
		  window.location.replace("spotifyAn.html");
		} else {
		  localStorage.removeItem(stateKey);
		  if (access_token) {
			$.ajax({
				url: 'https://api.spotify.com/v1/me',
				headers: {
				  'Authorization': 'Bearer ' + access_token
				},
				success: function(response) {				  
				  $('#login').hide();
				  fetchData()
				}
			});
		  } 
		  console.log(access_token)
		  document.getElementById('login-button').addEventListener('click', function() {
			var client_id = '63650de8718241e5bafdfcab9dc1a256'; // Your client id
			var redirect_uri = 'https://joepitts.co.uk/spotifyAn.html'; // Your redirect uri
			var state = generateRandomString(16);
			localStorage.setItem(stateKey, state);
			var scope = 'user-top-read';
			var url = 'https://accounts.spotify.com/authorize';
			url += '?response_type=token';
			url += '&client_id=' + encodeURIComponent(client_id);
			url += '&scope=' + encodeURIComponent(scope);
			url += '&redirect_uri=' + encodeURIComponent(redirect_uri);
			url += '&state=' + encodeURIComponent(state);
			window.location = url;
		  }, false);
		}
	  })();
	  function fetchData(){
		var spotifyApi = new SpotifyWebApi();
		spotifyApi.setAccessToken(access_token);
		options = {
			time_range: document.getElementById('time').value,
			limit: 50,
			offset: 0
		}
		spotifyApi.getMyTopArtists(options).then(function(data) {
			jsonData = data
			draw();
			console.log(data);
		  }, function(err) {
			console.error(err);
		  });
	  }
		
	app.get('/login', function(req, res) {
	var scopes = 'user-top-read';
	res.redirect('https://accounts.spotify.com/authorize' +
	  '?response_type=code' +
	  '&client_id=' + my_client_id +
	  (scopes ? '&scope=' + encodeURIComponent(scopes) : '') +
	  '&redirect_uri=' + encodeURIComponent(redirect_uri));
	});
	var nodes = null;
	var edges = null;
	var network = null;
	// Called when the Visualization API is loaded.
	function draw() {
	  // create people.
	  // value corresponds with the age of the person
	  var DIR = '../img/indonesia/';
	  nodes = []
	  data = jsonData;
	  artistsID = []
	  for (x = 0; x < data.items.length; x++){
	  	// nodes[x] = [(data.items[x].images[2].url), data.items[x].popularity]
		try{
	  		nodes[x]  = {id: x,  shape: 'circularImage', image: data.items[x].images[2].url, size: data.items[x].popularity / 2, label: data.items[x].name, mass: (data.items[x].popularity / 25)}
		}catch{
			nodes[x]  = {id: x,  shape: 'circularImage', image: "../defaut.jpeg", size: data.items[x].popularity / 2, label: data.items[x].name, mass: (data.items[x].popularity / 25)}
		}
			artistsID[x] = data.items[x].id
	  }
	  foundCons = []
	  	function worker(index, data){
			console.log(index)
			foundCons[index] = data
			for (z = 0; z < data.artists.length; z++){
				// console.log(currentArtist)
				target = artistsID.indexOf(data.artists[z].id)
				if (target >= 0){
					if (index < target ){											
						edges.push({from: index , to: target})
					} else {
						edges.push({from: target , to: index})
					}
				}
			}
	  	}
		function sortEdges(callback) {
		
			edges = []
			for (y = 0; y-1 <  artistsID.length; y++){
				var spotifyApi = new SpotifyWebApi();
				spotifyApi.setAccessToken(access_token);
				currentArtist = artistsID[y]
				console.log(y)
				if (y === artistsID.length){
					window.setTimeout(callback, 1000, edges);					
				}
				spotifyApi.getArtistRelatedArtists(artistsID[y]).then(worker.bind(null, y))
			}
			if (y === artistsID.length){
				console.log(edges)
				// callback(edges);
			}
		}
		sortEdges(buildGraph)
		function buildGraph(edges){
			var container = document.getElementById('mynetwork');
			container.height = 8000;
			var data = {
				nodes: nodes,
				edges: edges
			};
			var options = {
				nodes: {
					borderWidth:4,
					color: {
						border: '#222222',
						background: '#666666'
				  },
				  font:{color:'#000000'}
				},
			  "edges": {
				"smooth": {
				  "forceDirection": "none"				
				},
				color: 'lightgray'
			  },
			  "physics": {
				"barnesHut": {
				  "centralGravity": 1,
				  "springLength": 110,
				  "springConstant": 0.05,
				  "damping": 0.94
				},
				"minVelocity": 0.75
			  }
			}
			if (nightCookie[1] === "true"){
				options["edges"].color = "d9d9d9";
				options.nodes.font.color = "white";

			}
			options.height = window.top.innerHeight - document.getElementById("footer").clientHeight - document.getElementById("content").clientHeight + 'px';
			network = new vis.Network(container, data, options);
				
			 }
		}
	</script>
	<!-- <body onload="draw()"> -->



	<div id = "gallery">
		<div id="mynetwork"></div>
	</div>


    <div class="footer" id = "footer">
        <p align="center"><a href="https://linkedin.com/in/JoePittsy">LinkedIn</a>&nbsp;&nbsp;
        <a href="https://twitter.com/JoePittsy">Twitter</a>&nbsp;&nbsp;<a href="https://instagram.com/JoePittsy">Instagram</a>&nbsp;&nbsp;<a href=" https://github.com/Pittsy24">GitHub</a></p>
    </div>
</body>
</html>
